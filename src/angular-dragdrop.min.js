/**
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 */

/**
 * Implementing Drag and Drop functionality in AngularJS is easier than ever.
 * Demo: http://codef0rmer.github.com/angular-dragdrop/
 * 
 * @version 1.0.0
 *
 * (c) 2013 Amit Gharat a.k.a codef0rmer <amit.2006.it@gmail.com> - amitgharat.wordpress.com
 */
var jqyoui=angular.module("ngDragDrop",[]).directive("jqyouiDraggable",function(){return{require:"?jqyouiDroppable",restrict:"A",link:function(t,a,e){var i,o=function(o){o?(i=t.$eval(a.attr("jqyoui-draggable"))||[],a.draggable({disabled:!1}).draggable(t.$eval(e.jqyouiOptions)||{}).draggable({start:function(a,e){$(this).css("z-index",99999),jqyoui.startXY=$(this).offset(),i.onStart&&t[i.onStart](a,e)},stop:function(a,e){i.onStop&&t[i.onStop](a,e)},drag:function(a,e){i.onDrag&&t[i.onDrag](a,e)}})):a.draggable({disabled:!0})};t.$watch(function(){return t.$eval(e.drag)},o),o()}}}).directive("jqyouiDroppable",["$timeout",function(t){return{restrict:"A",priority:1,link:function(a,e,i){var o=function(o){o?e.droppable({disabled:!1}).droppable(a.$eval(i.jqyouiOptions)||{}).droppable({over:function(t,e){var i=a.$eval(angular.element(this).attr("jqyoui-droppable"))||[];i.onOver&&a[i.onOver](t,e)},out:function(t,e){var i=a.$eval(angular.element(this).attr("jqyoui-droppable"))||[];i.onOut&&a[i.onOut](t,e)},drop:function(e,i){jqyoui.invokeDrop(angular.element(i.draggable),angular.element(this),a,t,e,i)}}):e.droppable({disabled:!0})};a.$watch(function(){return a.$eval(i.drop)},o),o()}}}]);jqyoui.invokeDrop=function(t,a,e,i,o,n){var r="",l="",u={},s={},p=null,d={},g={},c=null;r=t.attr("ng-model"),l=a.attr("ng-model"),c=a.find("[jqyoui-draggable]:last"),s=e.$eval(a.attr("jqyoui-droppable"))||[],u=e.$eval(t.attr("jqyoui-draggable"))||[],p=angular.isArray(e[r])?u.index:null,d=angular.isArray(e[r])?e[r][p]:e[r],g=(angular.isArray(e[l])&&s&&void 0!==s.index?e[l][s.index]:angular.isArray(e[l])?{}:e[l])||{},u.animate===!0?(jqyoui.move(t,c.length>0?c:a,null,"fast",s,null),jqyoui.move(c.length>0&&!s.multiple?c:[],t.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",s,function(){i(function(){t.css({position:"relative",left:"",top:""}),c.css({position:"relative",left:"",top:""}),jqyoui.mutateDraggable(e,s,u,r,l,g,t),jqyoui.mutateDroppable(e,s,u,l,d,p),s.onDrop&&e[s.onDrop](o,n)})})):i(function(){jqyoui.mutateDraggable(e,s,u,r,l,g,t),jqyoui.mutateDroppable(e,s,u,l,d,p),s.onDrop&&e[s.onDrop](o,n)})},jqyoui.move=function(t,a,e,i,o,n){if(0===t.length)return n&&window.setTimeout(function(){n()},300),!1;var r=9999,l=t.offset(),u=a&&a.is(":visible");null===e&&a.length>0&&(void 0!==a.attr("jqyoui-draggable")&&void 0!==a.attr("ng-model")&&a.is(":visible")&&o&&o.multiple?(e=a.offset(),o.stack===!1?e.left+=a.outerWidth(!0):e.top+=a.outerHeight(!0)):(e=a.css({visibility:"hidden",display:"block"}).offset(),a.css({visibility:"",display:u?"":"none"}))),t.css({position:"absolute","z-index":r}).css(l).animate(e,i,function(){n&&n()})},jqyoui.mutateDroppable=function(t,a,e,i,o,n){angular.isArray(t[i])?(a&&a.index>=0?t[i][a.index]=o:t[i].push(o),e&&e.placeholder&&(t[i][t[i].length-1].jqyoui_pos=n)):(t[i]=o,e&&e.placeholder&&(t[i].jqyoui_pos=n))},jqyoui.mutateDraggable=function(t,a,e,i,o,n,r){var l=$.isEmptyObject(n);e&&e.placeholder?angular.isArray(t[i])&&void 0!==e.index?t[i][e.index]=n:t[i]=n:angular.isArray(t[i])?l?e&&!e.immutable&&t[i].splice(e.index,1):t[i][e.index]=n:(t[i]=n,t.$parent&&(t.$parent[i]=n)),r.css({"z-index":"",left:"",top:""})};