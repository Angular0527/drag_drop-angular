var jqyoui=angular.module("ngDragDrop",[]).service("ngDragDropService",["$timeout",function($timeout){this.callEventCallback=function(scope,callbackName,event,ui){if(callbackName){var args=[event,ui],match=callbackName.match(/^(.+)\((.+)\)$/);null!==match&&(callbackName=match[1],values=eval("["+match[0].replace(/^(.+)\(/,"").replace(/\)/,"")+"]"),args.push.apply(args,values)),scope[callbackName].apply(scope,args)}},this.invokeDrop=function(a,t,e,i,l){var n="",r="",o={},s={},u=null,c={},p={},d=null;n=a.attr("ng-model"),r=t.attr("ng-model"),d=t.find("[jqyoui-draggable]:last"),s=e.$eval(t.attr("jqyoui-droppable"))||[],o=e.$eval(a.attr("jqyoui-draggable"))||[],u=angular.isArray(e[n])?o.index:null,c=angular.isArray(e[n])?e[n][u]:e[n],p=(angular.isArray(e[r])&&s&&void 0!==s.index?e[r][s.index]:angular.isArray(e[r])?{}:e[r])||{},o.animate===!0?(this.move(a,d.length>0?d:t,null,"fast",s,null),this.move(d.length>0&&!s.multiple?d:[],a.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",s,function(){$timeout(function(){a.css({position:"relative",left:"",top:""}),d.css({position:"relative",left:"",top:""}),this.mutateDraggable(e,s,o,n,r,p,a),this.mutateDroppable(e,s,o,r,c,u),this.callEventCallback(e,s.onDrop,i,l)}.bind(this))}.bind(this))):$timeout(function(){this.mutateDraggable(e,s,o,n,r,p,a),this.mutateDroppable(e,s,o,r,c,u),this.callEventCallback(e,s.onDrop,i,l)}.bind(this))},this.move=function(a,t,e,i,l,n){if(0===a.length)return n&&window.setTimeout(function(){n()},300),!1;var r=9999,o=a.offset(),s=t&&t.is(":visible");null===e&&t.length>0&&(void 0!==t.attr("jqyoui-draggable")&&void 0!==t.attr("ng-model")&&t.is(":visible")&&l&&l.multiple?(e=t.offset(),l.stack===!1?e.left+=t.outerWidth(!0):e.top+=t.outerHeight(!0)):(e=t.css({visibility:"hidden",display:"block"}).offset(),t.css({visibility:"",display:s?"":"none"}))),a.css({position:"absolute","z-index":r}).css(o).animate(e,i,function(){n&&n()})},this.mutateDroppable=function(a,t,e,i,l,n){angular.isArray(a[i])?(t&&t.index>=0?a[i][t.index]=l:a[i].push(l),e&&e.placeholder&&(a[i][a[i].length-1].jqyoui_pos=n)):(a[i]=l,e&&e.placeholder&&(a[i].jqyoui_pos=n))},this.mutateDraggable=function(a,t,e,i,l,n,r){var o=$.isEmptyObject(n);e&&e.placeholder?angular.isArray(a[i])&&void 0!==e.index?a[i][e.index]=n:a[i]=n:angular.isArray(a[i])?o?a[i].splice(e.index,1):a[i][e.index]=n:(a[i]=n,a.$parent&&(a.$parent[i]=n)),r.css({"z-index":"",left:"",top:""})}}]).directive("jqyouiDraggable",["ngDragDropService",function(a){return{require:"?jqyouiDroppable",restrict:"A",link:function(t,e,i){var l,n=function(n){n?(l=t.$eval(e.attr("jqyoui-draggable"))||[],e.draggable({disabled:!1}).draggable(t.$eval(i.jqyouiOptions)||{}).draggable({start:function(e,i){$(this).css("z-index",99999),jqyoui.startXY=$(this).offset(),a.callEventCallback(t,l.onStart,e,i)},stop:function(e,i){a.callEventCallback(t,l.onStop,e,i)},drag:function(e,i){a.callEventCallback(t,l.onDrag,e,i)}})):e.draggable({disabled:!0})};t.$watch(function(){return t.$eval(i.drag)},n),n()}}}]).directive("jqyouiDroppable",["ngDragDropService",function(a){return{restrict:"A",priority:1,link:function(t,e,i){var l=function(l){l?e.droppable({disabled:!1}).droppable(t.$eval(i.jqyouiOptions)||{}).droppable({over:function(e,i){var l=t.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(t,l.onOver,e,i)},out:function(e,i){var l=t.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(t,l.onOut,e,i)},drop:function(e,i){a.invokeDrop(angular.element(i.draggable),angular.element(this),t,e,i)}}):e.droppable({disabled:!0})};t.$watch(function(){return t.$eval(i.drop)},l),l()}}}]);