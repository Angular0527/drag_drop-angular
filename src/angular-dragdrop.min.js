var jqyoui=angular.module("ngDragDrop",[]).service("ngDragDropService",["$timeout",function($timeout){this.callEventCallback=function(scope,callbackName,event,ui){if(callbackName){var args=[event,ui],match=callbackName.match(/^(.+)\((.+)\)$/);null!==match&&(callbackName=match[1],values=eval("["+match[0].replace(/^(.+)\(/,"").replace(/\)/,"")+"]"),args.push.apply(args,values)),scope[callbackName].apply(scope,args)}},this.invokeDrop=function(a,e,t,i,l){var n="",r="",o={},s={},u=null,c={},p={},d=null;n=a.attr("ng-model"),r=e.attr("ng-model"),d=e.find("[jqyoui-draggable]:last"),s=t.$eval(e.attr("jqyoui-droppable"))||[],o=t.$eval(a.attr("jqyoui-draggable"))||[],u=angular.isArray(t[n])?o.index:null,c=angular.isArray(t[n])?t[n][u]:t[n],p=(angular.isArray(t[r])&&s&&void 0!==s.index?t[r][s.index]:angular.isArray(t[r])?{}:t[r])||{},o.animate===!0?(this.move(a,d.length>0?d:e,null,"fast",s,null),this.move(d.length>0&&!s.multiple?d:[],a.parent("[jqyoui-droppable]"),jqyoui.startXY,"fast",s,function(){$timeout(function(){a.css({position:"relative",left:"",top:""}),d.css({position:"relative",left:"",top:""}),this.mutateDraggable(t,s,o,n,r,p,a),this.mutateDroppable(t,s,o,r,c,u),this.callEventCallback(t,s.onDrop,i,l)}.bind(this))}.bind(this))):$timeout(function(){this.mutateDraggable(t,s,o,n,r,p,a),this.mutateDroppable(t,s,o,r,c,u),this.callEventCallback(t,s.onDrop,i,l)}.bind(this))},this.move=function(a,e,t,i,l,n){if(0===a.length)return n&&window.setTimeout(function(){n()},300),!1;var r=9999,o=a.offset(),s=e&&e.is(":visible");null===t&&e.length>0&&(void 0!==e.attr("jqyoui-draggable")&&void 0!==e.attr("ng-model")&&e.is(":visible")&&l&&l.multiple?(t=e.offset(),l.stack===!1?t.left+=e.outerWidth(!0):t.top+=e.outerHeight(!0)):(t=e.css({visibility:"hidden",display:"block"}).offset(),e.css({visibility:"",display:s?"":"none"}))),a.css({position:"absolute","z-index":r}).css(o).animate(t,i,function(){n&&n()})},this.mutateDroppable=function(a,e,t,i,l,n){angular.isArray(a[i])?(e&&e.index>=0?a[i][e.index]=l:a[i].push(l),t&&t.placeholder&&(a[i][a[i].length-1].jqyoui_pos=n)):(a[i]=l,t&&t.placeholder&&(a[i].jqyoui_pos=n))},this.mutateDraggable=function(a,e,t,i,l,n,r){var o=$.isEmptyObject(n);t&&t.placeholder?angular.isArray(a[i])&&void 0!==t.index?a[i][t.index]=n:a[i]=n:angular.isArray(a[i])?o?a[i].splice(t.index,1):a[i][t.index]=n:(a[i]=n,a.$parent&&(a.$parent[i]=n)),r.css({"z-index":"",left:"",top:""})}}]).directive("jqyouiDraggable",["ngDragDropService",function(a){return{require:"?jqyouiDroppable",restrict:"A",link:function(e,t,i){var l,n=function(n){n?(l=e.$eval(t.attr("jqyoui-draggable"))||[],t.draggable({disabled:!1}).draggable(e.$eval(i.jqyouiOptions)||{}).draggable({start:function(t,i){$(this).css("z-index",99999),jqyoui.startXY=$(this).offset(),a.callEventCallback(e,l.onStart,t,i)},stop:function(t,i){a.callEventCallback(e,l.onStop,t,i)},drag:function(t,i){a.callEventCallback(e,l.onDrag,t,i)}})):t.draggable({disabled:!0})};e.$watch(function(){return e.$eval(i.drag)},n),n()}}}]).directive("jqyouiDroppable",["ngDragDropService",function(a){return console.log("droppable directive"),{restrict:"A",priority:1,link:function(e,t,i){var l=function(l){l?(console.log("droppable directive element setting"),t.droppable({disabled:!1}).droppable(e.$eval(i.jqyouiOptions)||{}).droppable({over:function(t,i){var l=e.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(e,l.onOver,t,i)},out:function(t,i){var l=e.$eval(angular.element(this).attr("jqyoui-droppable"))||[];a.callEventCallback(e,l.onOut,t,i)},drop:function(t,i){a.invokeDrop(angular.element(i.draggable),angular.element(this),e,t,i)}})):t.droppable({disabled:!0})};e.$watch(function(){return e.$eval(i.drop)},l),l()}}}]);